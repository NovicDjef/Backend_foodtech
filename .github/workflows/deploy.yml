name: Deploy API to VPS

on:
  push:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            set -e  # ArrÃªter si une commande Ã©choue
            echo "ğŸš€ Starting deployment..."
            
            # Variables CORRIGÃ‰ES
            APP_DIR="/var/www/Backend_foodtech"
            BACKUP_DIR="/var/www/backups"
            APP_NAME="Backend_foodtech"
            REPO_URL="https://${{ secrets.GH_TOKEN }}@github.com/${{ github.repository }}.git"
            
            echo "ğŸ“ App directory: $APP_DIR"
            echo "ğŸ“¦ App name: $APP_NAME"
            
            # CrÃ©er les rÃ©pertoires s'ils n'existent pas
            sudo mkdir -p $APP_DIR
            sudo mkdir -p $BACKUP_DIR
            
            # Backup de l'ancienne version si elle existe
            if [ -d "$APP_DIR" ] && [ "$(ls -A $APP_DIR 2>/dev/null)" ]; then
              echo "ğŸ“¦ Creating backup..."
              sudo cp -r $APP_DIR $BACKUP_DIR/backup-$(date +%Y%m%d-%H%M%S)
            fi
            
            # Nettoyer le rÃ©pertoire de destination
            echo "ğŸ§¹ Cleaning destination directory..."
            sudo rm -rf $APP_DIR/*
            sudo rm -rf $APP_DIR/.[^.]*
            
            # Cloner le repository
            echo "ğŸ“¥ Cloning repository..."
            sudo git clone $REPO_URL $APP_DIR
            
            # Changer vers le rÃ©pertoire de l'app
            cd $APP_DIR
            
            echo "ğŸ“‚ Files after clone:"
            ls -la
            
            # Installer les dÃ©pendances
            echo "ğŸ“¦ Installing dependencies..."
            sudo npm install --production
            
            # GÃ©nÃ©rer Prisma Client
            echo "âš™ï¸ Generating Prisma Client..."
            sudo npx prisma generate
            
            # CrÃ©er/mettre Ã  jour le fichier .env
            echo "ğŸ”§ Setting up environment..."
            if [ ! -f ".env" ]; then
              sudo tee .env > /dev/null <<EOF
            NODE_ENV=production
            PORT=3001
            # Ajoutez vos autres variables d'environnement ici
            DATABASE_URL="your-database-url-here"
            EOF
            fi
            
            # GÃ©rer PM2
            echo "ğŸ”„ Managing PM2 process..."
            
            # Installer PM2 globalement si pas installÃ©
            if ! command -v pm2 &> /dev/null; then
              echo "Installing PM2..."
              sudo npm install -g pm2
            fi
            
            # ArrÃªter le processus existant
            sudo pm2 stop $APP_NAME 2>/dev/null || echo "Process not running"
            sudo pm2 delete $APP_NAME 2>/dev/null || echo "Process not found"
            
            # Identifier le fichier principal
            MAIN_FILE=""
            if [ -f "server.js" ]; then
              MAIN_FILE="server.js"
            elif [ -f "index.js" ]; then
              MAIN_FILE="index.js"
            elif [ -f "app.js" ]; then
              MAIN_FILE="app.js"
            else
              echo "âŒ No main file found (server.js, index.js, or app.js)"
              exit 1
            fi
            
            echo "ğŸš€ Starting application with: $MAIN_FILE"
            
            # DÃ©marrer l'application
            sudo pm2 start $MAIN_FILE --name $APP_NAME
            sudo pm2 save
            
            # Configuration du dÃ©marrage automatique
            sudo pm2 startup systemd -u root --hp /root 2>/dev/null || echo "PM2 startup already configured"
            
            echo "âœ… Deployment completed!"
            echo "ğŸ“Š PM2 Status:"
            sudo pm2 list
            
            echo "ğŸŒ Testing local connection..."
            sleep 2
            curl -f http://localhost:3001 && echo "âœ… Local test passed" || echo "âŒ Local test failed"
            
            # Nettoyage des anciens backups (garder les 3 derniers)
            echo "ğŸ§¹ Cleaning old backups..."
            cd $BACKUP_DIR
            sudo ls -t | tail -n +4 | xargs -r sudo rm -rf